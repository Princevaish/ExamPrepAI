{% extends "base.html" %}
{% block title %}MCQ Generator{% endblock %}
{% block body %}

<style>
  .mcq-hero {
    height: 75vh;
    background: linear-gradient(135deg, rgba(15, 32, 39, 0.65), rgba(32, 58, 67, 0.65)), 
                url("https://images.pexels.com/photos/590493/pexels-photo-590493.jpeg?auto=compress&cs=tinysrgb&w=1600") center/cover no-repeat fixed;
    position: relative;
    padding: 40px 0;
    display: flex;
    align-items: center;
    overflow: hidden;
  }

  .mcq-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.15), transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 179, 255, 0.15), transparent 50%);
    animation: heroGlow 8s ease-in-out infinite alternate;
    pointer-events: none;
  }

  @keyframes heroGlow {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  .mcq-hero .overlay {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1;
  }

  .glass-box {
    position: relative;
    z-index: 2;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.37),
      0 0 60px rgba(0, 255, 255, 0.3),
      inset 0 0 40px rgba(255, 255, 255, 0.05);
    transition: all 0.4s ease;
    animation: fadeIn 1.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .glass-box:hover {
    transform: translateY(-5px);
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.4),
      0 0 80px rgba(0, 255, 255, 0.5);
  }

  .glass-btn {
    background: linear-gradient(135deg, #00ffff, #00b3ff);
    border: none;
    backdrop-filter: blur(6px);
    padding: 12px 32px;
    border-radius: 50px;
    color: #000 !important;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    text-decoration: none;
    display: inline-block;
  }

  .glass-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 0 40px rgba(0, 255, 255, 0.9);
    color: #000 !important;
  }

  .animate-fade {
    animation: fadeIn 1.2s ease-in-out;
  }

  @media (max-width: 768px) {
    .mcq-hero {
      height: 60vh;
    }
  }

  .glass-card-neo {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    backdrop-filter: blur(20px);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.37),
      0 0 60px rgba(0, 255, 255, 0.2),
      inset 0 0 40px rgba(255, 255, 255, 0.05);
    transition: all 0.4s ease;
    animation: slideUp 0.8s ease-out;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .glass-card-neo:hover {
    transform: translateY(-6px);
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.4),
      0 0 80px rgba(0, 255, 255, 0.4);
    border-color: rgba(0, 255, 255, 0.4);
  }

  .icon-circle {
    height: 60px;
    width: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 179, 255, 0.2));
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(12px);
    font-size: 1.8rem;
    box-shadow: 
      0 4px 15px rgba(0, 0, 0, 0.3),
      inset 0 0 20px rgba(255, 255, 255, 0.1);
    animation: iconFloat 3s ease-in-out infinite;
  }

  @keyframes iconFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .glass-input,
  .glass-select,
  textarea.glass-input,
  select.glass-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.4);
    color: #fff;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
  }

  .glass-input:focus,
  .glass-select:focus,
  textarea.glass-input:focus,
  select.glass-input:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #00ffff;
    box-shadow: 
      0 0 20px rgba(0, 255, 255, 0.6),
      inset 0 0 15px rgba(0, 255, 255, 0.3);
    color: #fff;
    outline: none;
  }

  .glass-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  select.glass-input.form-select-lg {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(0, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.9);
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.5),
      0 0 30px rgba(0, 255, 255, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    font-weight: 500;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300ffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  select.glass-input.form-select-lg:hover {
    background: rgba(255,255,255,0.25);
    border-color: rgba(0, 255, 255, 0.5);
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.5),
      0 0 40px rgba(0, 255, 255, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  select.glass-input.form-select-lg:focus {
    background: rgba(255,255,255,0.11);
    border-color: #00ffff;
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.5),
      0 0 50px rgba(0, 255, 255, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    color: #fff;
    outline: none;
  }

  select.glass-input.form-select-lg option {
    background: rgba(15, 32, 39, 0.98);
    color: rgba(255, 255, 255, 0.85);
    padding: 0.65rem 1rem;
    font-weight: 500;
    border: none;
  }

  select.glass-input.form-select-lg option:hover {
    background: rgba(0, 255, 255, 0.15);
    color: #00ffff;
  }

  select.glass-input.form-select-lg option:checked {
    background: rgba(0, 255, 255, 0.25);
    color: #00ffff;
    font-weight: 600;
  }

  @-moz-document url-prefix() {
    select.glass-input.form-select-lg option {
      background: #0f2027;
      color: rgba(255, 255, 255, 0.85);
    }
    
    select.glass-input.form-select-lg option:hover {
      background: rgba(0, 255, 255, 0.15);
      color: #00ffff;
    }
  }

  .form-label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
  }

  .big-btn {
    padding: 16px 24px;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    transition: all 0.4s ease;
  }

  .shadow-neon-blue {
    box-shadow: 0 0 25px rgba(0, 153, 255, 0.6);
  }

  .shadow-neon-green {
    box-shadow: 0 0 25px rgba(0, 255, 0, 0.6);
  }

  .pulse-hover:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 0 40px rgba(0, 153, 255, 0.8);
    animation: pulse 0.6s ease-in-out;
  }

  @keyframes pulse {
    0%, 100% { transform: translateY(-3px) scale(1.02); }
    50% { transform: translateY(-3px) scale(1.05); }
  }

  .neon-border {
    border: 1px solid rgba(0, 255, 255, 0.6);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
  }

  .neon-download:hover {
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
    border-color: rgba(0, 255, 255, 0.9);
  }

  .download-text {
    color: #000;
    font-weight: 600;
  }

  .mcq-box {
    background: rgba(255, 255, 255, 0.06);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    transition: all 0.4s ease;
    box-shadow: 
      0 4px 20px rgba(0, 0, 0, 0.3),
      inset 0 0 20px rgba(255, 255, 255, 0.03);
  }

  .mcq-box:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(0, 200, 255, 0.5);
    box-shadow: 
      0 6px 30px rgba(0, 0, 0, 0.4),
      0 0 25px rgba(0, 200, 255, 0.4);
    transform: translateX(5px);
  }

  .mcq-box p {
    color: #fff;
  }

  .mcq-box ul li {
    color: rgba(255, 255, 255, 0.85);
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }

  .mcq-box ul li:last-child {
    border-bottom: none;
  }

  .mcq-box ul li:hover {
    color: #00ffff;
    padding-left: 10px;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  }

  .answer-box {
    background: linear-gradient(135deg, rgba(0, 255, 0, 0.15), rgba(40, 167, 69, 0.15));
    border-left: 4px solid #28a745;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    box-shadow: 
      0 4px 15px rgba(0, 0, 0, 0.2),
      inset 0 0 15px rgba(0, 255, 0, 0.1);
  }

  .answer-box strong {
    color: #00ff88;
    text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
  }

  .answer-box .badge {
    background: linear-gradient(135deg, #28a745, #00ff88);
    color: #000;
    font-weight: 700;
    padding: 6px 16px;
    border-radius: 20px;
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
  }

  .animate-slide-up {
    animation: slideUp 0.8s ease-out forwards;
  }

  .btn-primary {
    background: linear-gradient(135deg, #00ffff, #00b3ff);
    border: none;
    color: #000;
    font-weight: 700;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #00b3ff, #0088ff);
    color: #000;
    transform: translateY(-2px);
  }

  .btn-success {
    background: linear-gradient(135deg, #28a745, #00ff88);
    border: none;
    color: #000;
    font-weight: 700;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #00ff88, #20c997);
    color: #000;
    transform: translateY(-2px);
  }

  html {
    scroll-behavior: smooth;
  }

  .alert-danger {
    background: rgba(255, 0, 0, 0.15);
    border: 1px solid rgba(255, 0, 0, 0.4);
    color: #ff6b6b;
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
  }

  h3 {
    color: #fff;
    text-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
  }

  .text-primary {
    color: #00ffff !important;
  }

  .text-success {
    color: #00ff88 !important;
  }

  /* ===== ASYNC LOADING STYLES (ADDED) ===== */
  .loading-spinner {
    border: 4px solid rgba(0, 255, 255, 0.3);
    border-top: 4px solid #00ffff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-container {
    text-align: center;
    padding: 3rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .alert-info {
    background: rgba(0, 191, 255, 0.15);
    border: 1px solid rgba(0, 191, 255, 0.4);
    color: #00bfff;
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2);
  }
  /* ===== END ASYNC LOADING STYLES ===== */

  @media (max-width: 768px) {
    .big-btn {
      font-size: 1rem;
      padding: 14px 20px;
    }

    .glass-box {
      padding: 2rem 1.5rem;
    }

    .glass-card-neo {
      padding: 2rem 1.5rem;
    }
  }
</style>

<!-- ========== HERO SECTION ========== -->
<section class="mcq-hero d-flex align-items-center text-white">
  <div class="overlay"></div>

  <div class="container position-relative">
    <div class="col-md-8 col-lg-6 glass-box p-4 p-md-5 animate-fade">
      <h1 class="fw-bold display-4 mb-3">AI MCQ Generator</h1>
      <p class="lead mb-4">
        Generate high-quality, exam-ready MCQs instantly. Smart, fast, and powered by advanced AI.
      </p>

      <a href="#mcqForm" class="glass-btn btn-lg">
        Start Generating MCQs
      </a>
    </div>
  </div>
</section>

<!-- ========================= MAIN CONTENT ========================= -->
<div class="container my-5">

  <!-- ERROR MESSAGE -->
  {% if error %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Error:</strong> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <!-- ===== ASYNC LOADING MESSAGE (ADDED) ===== -->
  {% if task_id %}
  <div class="glass-card-neo p-4 p-md-5 shadow-xxl mb-4 animate-slide-up" id="loadingSection">
    <div class="loading-container">
      <div class="loading-spinner mb-4"></div>
      <h4 class="fw-bold mb-3">⚡ Generating MCQs...</h4>
      <p class="lead mb-0">{{ message|default:"Please wait while we generate your MCQs. This may take a moment." }}</p>
      <p class="text-muted mt-2" style="color: rgba(255, 255, 255, 0.6) !important;">
      </p>
    </div>
  </div>
  {% endif %}
  <!-- ===== END ASYNC LOADING MESSAGE ===== -->

  <!-- FORM CARD -->
  <div class="glass-card-neo p-4 p-md-5 shadow-xxl animate-slide-up">

    <div class="d-flex align-items-center mb-4">
      <div class="icon-circle me-3">
        <i class="bi bi-ui-checks text-primary"></i>
      </div>
      <h3 class="fw-bold mb-0">Create Your MCQs</h3>
    </div>

    <form id="mcqForm" method="post" action="{% url 'mcq_async' %}">
      {% csrf_token %}

      <!-- TEXT INPUT -->
      <label class="form-label fw-bold">Enter Topic / Notes</label>
      <textarea class="form-control form-control-lg glass-input subtle-border mb-4"
        rows="5" name="topic" required
        placeholder="Paste your chapter, topic, or notes...">{{ topic|default:"" }}</textarea>

      <!-- NUMBERS + DIFFICULTY -->
      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label fw-bold">Number of MCQs</label>
          <input type="number" class="form-control form-control-lg glass-input subtle-border"
            name="count" placeholder="e.g., 10" min="1" max="50" required
            value="{{ count|default:'' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label fw-bold">Difficulty Level</label>
          <select class="form-select form-select-lg glass-input subtle-border" name="difficulty">
            <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>Easy</option>
            <option value="medium" {% if difficulty == 'medium' or not difficulty %}selected{% endif %}>Medium</option>
            <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>Hard</option>
          </select>
        </div>
      </div>

      <!-- BUTTONS -->
      <div class="d-flex gap-3">
        
        <!-- GENERATE BUTTON -->
        <button type="submit" class="btn btn-primary btn-lg w-100 big-btn pulse-hover shadow-neon-blue">
          ⚡ Generate MCQs
        </button>

        <!-- ===== ASYNC PDF DOWNLOAD BUTTON (ADDED) ===== -->
        <a href="{% url 'download_mcq_pdf' %}" id="pdfDownloadBtn" class="btn btn-lg w-50 glass-btn neon-border neon-download" style="display: none;">
          <span class="download-text">⬇ Download PDF</span>
        </a>
        <!-- ===== END ASYNC PDF DOWNLOAD BUTTON ===== -->

      </div>

    </form>
  </div>


  <!-- ========================= GENERATED MCQs SECTION ========================= -->
  {% if mcqs %}
  <div class="glass-card-neo p-4 p-md-5 shadow-xxl mt-5 animate-slide-up" id="mcqResults">

    <div class="d-flex align-items-center mb-4">
      <div class="icon-circle me-3">
        <i class="bi bi-card-checklist text-success"></i>
      </div>
      <h3 class="fw-bold mb-0">Generated MCQs ({{ mcqs|length }})</h3>
    </div>

    {% for mcq in mcqs %}
    <div class="mcq-box p-4 mb-4 subtle-border">
      <p class="fw-bold fs-5 mb-3">Q{{ forloop.counter }}. {{ mcq.question }}</p>

      <ul class="list-unstyled ms-3">
        {% for opt in mcq.options %}
        <li class="mb-2">{{ opt }}</li>
        {% endfor %}
      </ul>

      <div class="mt-3 p-2 answer-box">
        <strong class="text-success">✓ Answer:</strong> <span class="badge bg-success">{{ mcq.answer }}</span>
      </div>
    </div>
    {% endfor %}

    <!-- Download button -->
    <a href="{% url 'download_mcq_pdf' %}" class="btn btn-lg btn-success w-100 mt-3 shadow-neon-green">
      ⬇ Download MCQ PDF
    </a>

  </div>
  {% endif %}

  <!-- ===== ASYNC RESULTS CONTAINER (ADDED) ===== -->
  <div id="asyncMcqResults"></div>
  <!-- ===== END ASYNC RESULTS CONTAINER ===== -->

</div>

<!-- Auto-scroll to results if MCQs exist -->
{% if mcqs %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const resultsSection = document.getElementById('mcqResults');
  if (resultsSection) {
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
});
</script>
{% endif %}

{% if task_id %}
<script>
(function() {
  const taskId = "{{ task_id }}";
  const statusUrl = `/ai/task-status/${taskId}/`; // ✅ FIXED
  let pollInterval;

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function pollTaskStatus() {
    fetch(statusUrl, {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('HTTP ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log('[POLL] Task Status:', data.status);

      if (data.ready && data.successful) {
        clearInterval(pollInterval);
        renderMCQs(data.result);
      } 
      else if (data.status === 'FAILURE') {
        clearInterval(pollInterval);
        showError('MCQ generation failed. Please try again.');
      }
    })
    .catch(error => {
      console.error('[ERROR] Polling failed:', error);
      clearInterval(pollInterval);
      showError('Error checking task status. Please refresh the page.');
    });
  }

  function renderMCQs(result) {
    document.getElementById('loadingSection')?.remove();

    const mcqs = Array.isArray(result) ? result : result?.mcqs || [];

    if (!mcqs.length) {
      showError('No MCQs were generated.');
      return;
    }

    const resultsContainer = document.getElementById('asyncMcqResults');

    let html = `
      <div class="glass-card-neo p-4 p-md-5 shadow-xxl mt-5 animate-slide-up" id="mcqResults">
        <div class="d-flex align-items-center mb-4">
          <div class="icon-circle me-3">
            <i class="bi bi-card-checklist text-success"></i>
          </div>
          <h3 class="fw-bold mb-0">Generated MCQs (${mcqs.length})</h3>
        </div>
    `;

    mcqs.forEach((mcq, i) => {
      html += `
        <div class="mcq-box p-4 mb-4 subtle-border">
          <p class="fw-bold fs-5 mb-3">Q${i + 1}. ${mcq.question}</p>
          <ul class="list-unstyled ms-3">
            ${mcq.options.map(opt => `<li class="mb-2">${opt}</li>`).join('')}
          </ul>
          <div class="mt-3 p-2 answer-box">
            <strong class="text-success">✓ Answer:</strong>
            <span class="badge bg-success">${mcq.answer}</span>
          </div>
        </div>
      `;
    });

    html += `
      <a href="{% url 'download_mcq_pdf' %}" class="btn btn-lg btn-success w-100 mt-3 shadow-neon-green">
        ⬇ Download MCQ PDF
      </a>
    </div>`;

    resultsContainer.innerHTML = html;

    document.getElementById('pdfDownloadBtn').style.display = 'inline-block';

    document.getElementById('mcqResults')
      .scrollIntoView({ behavior: 'smooth', block: 'start' });

    storeMCQsInSession(mcqs);
  }

  function storeMCQsInSession(mcqs) {
    fetch('/ai/store-mcqs/', { // ✅ safer
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mcqs: mcqs,
        title: "{{ topic|default:'Generated MCQs' }}"
      })
    });
  }

  function showError(message) {
    document.getElementById('loadingSection')?.remove();
    document.getElementById('asyncMcqResults').innerHTML = `
      <div class="alert alert-danger alert-dismissible fade show">
        <strong>Error:</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  pollInterval = setInterval(pollTaskStatus, 2000);
  pollTaskStatus();
})();

if (window.history.replaceState) {
  window.history.replaceState(null, null, window.location.href);
}
</script>
{% endif %}
{% endblock %}
